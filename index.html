<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subtitle Timing Synchronizer with Smart Matching (AI Enhanced)</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/727/727245.png">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 20px; }
        h1 { text-align: center; color: #333; margin-bottom: 10px; font-size: clamp(20px, 5vw, 32px); }
        .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: clamp(12px, 3vw, 16px); padding: 0 10px; }
        .upload-section { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px; }
        @media (min-width: 640px) { .container { padding: 40px; } .upload-section { grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; } }
        .upload-box { border: 3px dashed #667eea; border-radius: 15px; padding: 20px; text-align: center; transition: all 0.3s; cursor: pointer; }
        .upload-box:hover { border-color: #764ba2; background: #f8f9ff; }
        .upload-box.uploaded { border-color: #10b981; background: #f0fdf4; }
        .upload-box h3 { color: #333; margin-bottom: 10px; font-size: clamp(16px, 4vw, 20px); }
        .upload-box p { color: #666; font-size: clamp(12px, 3vw, 14px); margin-bottom: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-size: clamp(14px, 3vw, 16px); font-weight: bold; cursor: pointer; transition: all 0.3s; }
        @media (min-width: 640px) { .btn { padding: 12px 30px; } }
        .btn-upload { background: #667eea; color: white; }
        .btn-upload:hover { background: #5568d3; }
        .btn-sync { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: clamp(14px, 4vw, 18px); padding: 12px 25px; width: 100%; }
        @media (min-width: 640px) { .btn-sync { padding: 15px 40px; width: auto; } }
        .btn-sync:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .btn-sync:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-download { background: #10b981; color: white; font-size: clamp(14px, 4vw, 18px); padding: 12px 25px; width: 100%; }
        @media (min-width: 640px) { .btn-download { padding: 15px 40px; width: auto; } }
        .btn-download:hover { background: #059669; }
        .button-group { display: flex; flex-direction: column; gap: 10px; justify-content: center; margin-bottom: 20px; }
        @media (min-width: 640px) { .button-group { flex-direction: row; gap: 15px; } }
        .status { background: #eff6ff; border: 2px solid #3b82f6; border-radius: 10px; padding: 12px; text-align: center; margin-bottom: 15px; font-weight: bold; color: #1e40af; font-size: clamp(12px, 3vw, 16px); }
        .status.success { background: #f0fdf4; border-color: #10b981; color: #065f46; }
        .status.error { background: #fef2f2; border-color: #ef4444; color: #991b1b; }
        .status.warning { background: #fffbeb; border-color: #f59e0b; color: #92400e; }
        .preview { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 15px; margin-bottom: 15px; display: none; }
        .preview h3 { color: #333; margin-bottom: 10px; font-size: clamp(16px, 4vw, 20px); }
        .preview pre { background: white; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; max-height: 250px; overflow-y: auto; font-size: clamp(10px, 2.5vw, 12px); white-space: pre-wrap; word-break: break-word; }
        .instructions { background: #fef3c7; border: 2px solid #fbbf24; border-radius: 10px; padding: 15px; }
        .instructions h4 { color: #92400e; margin-bottom: 10px; font-size: clamp(14px, 3.5vw, 18px); }
        .instructions ol { color: #78350f; padding-left: 20px; font-size: clamp(12px, 3vw, 14px); }
        .instructions li { margin-bottom: 5px; }
        .notice {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            font-size: clamp(12px, 3vw, 16px);
        }
        input[type="file"] { display: none; }
        .icon { font-size: clamp(32px, 8vw, 48px); margin-bottom: 10px; }
        .checkmark { color: #10b981; font-size: clamp(16px, 4vw, 20px); margin-top: 10px; display: none; }
        #downloadBtn { display: none; }
        .optional-badge { display: inline-block; background: #fbbf24; color: white; padding: 3px 8px; border-radius: 12px; font-size: clamp(9px, 2vw, 11px); font-weight: bold; margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="notice">
            üß† Smart Matching ‡∂ë‡∂ö‡∂ß ‡∂∂‡∑ú‡∑Ñ‡∑ù ‡∑Ä‡∑ö‡∂Ω‡∑è‡∑Ä‡∂ö‡∑ä ‡∂ú‡∂≠ ‡∑Ä‡∂±‡∑î ‡∂á‡∂≠. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂∂‡∂Ω‡∑è ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±...
        </div>

        <h1>üé¨ Subtitle Smart Synchronizer (AI Enhanced)</h1>
        <p class="subtitle">Original timing + Sinhala translation smart matching (AI powered)</p>

        <div class="upload-section">
            <div class="upload-box" id="originalBox" onclick="document.getElementById('originalFile').click()">
                <div class="icon">‚è±Ô∏è</div>
                <h3>Original Subtitle</h3>
                <p>(‡∂ï‡∂±‡∑ë‡∂∏ ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä‡∂ö - timing ‡∑É‡∂≥‡∑Ñ‡∑è)</p>
                <button class="btn btn-upload">üìÅ Upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
                <div class="checkmark" id="originalCheck">‚úì Uploaded</div>
                <input type="file" id="originalFile" accept=".srt">
            </div>

            <div class="upload-box" id="translatedBox" onclick="document.getElementById('translatedFile').click()">
                <div class="icon">üìù</div>
                <h3>Sinhala Subtitle <span class="optional-badge">‡∑Ä‡∑í‡∂ö‡∂Ω‡∑ä‡∂¥</span></h3>
                <p>(‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑Ö - ‡∑Ä‡∂†‡∂± ‡∑É‡∂≥‡∑Ñ‡∑è)</p>
                <button class="btn btn-upload">üìÅ Upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
                <div class="checkmark" id="translatedCheck">‚úì Uploaded</div>
                <input type="file" id="translatedFile" accept=".srt">
            </div>
        </div>

        <div id="statusBox" class="status" style="display:none;"></div>

        <div class="button-group">
            <button class="btn btn-sync" id="syncBtn" onclick="syncSubtitles()">üîÑ Smart Sync ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
            <button class="btn btn-download" id="downloadBtn" onclick="downloadOutput()">‚¨áÔ∏è Download ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
        </div>

        <div class="preview" id="logBox" style="display:none; background:#000; color:#0f0;">
            <h3 style="color:white;">Live Log:</h3>
            <pre id="logText"></pre>
        </div>

        <div class="preview" id="previewBox">
            <h3>Preview:</h3>
            <pre id="previewText"></pre>
        </div>

        <div class="instructions">
            <h4>üìå ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂± ‡∂Ü‡∂ö‡∑è‡∂ª‡∂∫:</h4>
            <ol>
                <li>Original subtitle ‡∂ë‡∂ö upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (timing ‡∑É‡∂≥‡∑Ñ‡∑è)</li>
                <li>‡∑Ä‡∑í‡∂ö‡∂Ω‡∑ä‡∂¥ Sinhala subtitle ‡∂ë‡∂ö upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</li>
                <li>"Smart Sync" ‡∂î‡∂∂‡∂±‡∑ä‡∂±</li>
                <li>AI ‡∂ë‡∂ö meaning ‡∂Ö‡∂±‡∑î‡∑Ä best Sinhala match ‡∂ë‡∂ö ‡∑Ñ‡∑ú‡∂∫‡∂Ω‡∑è sync ‡∂ö‡∂ª‡∂∫‡∑í</li>
            </ol>
        </div>
    </div>

<script>
let model, originalContent = null, translatedContent = null, outputContent = null;

function log(msg) {
    const box = document.getElementById("logBox");
    const text = document.getElementById("logText");
    box.style.display = "block";
    text.textContent += msg + "\n";
    box.scrollTop = box.scrollHeight;
}

async function loadModel() {
    log("üß† AI model load ‡∑Ä‡∑ô‡∂±‡∑Ä‡∑è...");
    model = await use.load();
    log("‚úÖ AI model load ‡∂ã‡∂±‡∑è!");
}

function parseSRT(content) {
    const blocks = content.trim().split(/\n\s*\n/);
    return blocks.map(block => {
        const lines = block.split('\n');
        return { index: lines[0], timing: lines[1], text: lines.slice(2).join(' ') };
    });
}

function cosineSimilarity(a, b) {
    let dot = 0, magA = 0, magB = 0;
    for (let i = 0; i < a.length; i++) {
        dot += a[i] * b[i];
        magA += a[i] * a[i];
        magB += b[i] * b[i];
    }
    return dot / (Math.sqrt(magA) * Math.sqrt(magB));
}

async function smartMatch(originalSubs, translatedSubs) {
    log("‚öôÔ∏è AI embeddings generate ‡∑Ä‡∑ô‡∂±‡∑Ä‡∑è...");
    const origEmb = await model.embed(originalSubs.map(s => s.text));
    const tranEmb = await model.embed(translatedSubs.map(s => s.text));

    const origArr = await origEmb.array();
    const tranArr = await tranEmb.array();

    const result = [];
    for (let i = 0; i < translatedSubs.length; i++) {
        let bestIdx = 0, bestScore = -1;
        for (let j = 0; j < originalSubs.length; j++) {
            const score = cosineSimilarity(tranArr[i], origArr[j]);
            if (score > bestScore) {
                bestScore = score;
                bestIdx = j;
            }
        }
        result.push({ index: i + 1, timing: originalSubs[bestIdx].timing, text: translatedSubs[i].text });
        log(`üîç Sinhala line ${i+1} ‚Üí Original line ${bestIdx+1} (score: ${bestScore.toFixed(2)})`);
    }
    return result;
}

document.getElementById('originalFile').addEventListener('change', e => {
    const reader = new FileReader();
    reader.onload = ev => {
        originalContent = ev.target.result;
        document.getElementById('originalBox').classList.add('uploaded');
        document.getElementById('originalCheck').style.display = 'block';
        log("üü¶ Original file loaded");
    };
    reader.readAsText(e.target.files[0]);
});

document.getElementById('translatedFile').addEventListener('change', e => {
    const reader = new FileReader();
    reader.onload = ev => {
        translatedContent = ev.target.result;
        document.getElementById('translatedBox').classList.add('uploaded');
        document.getElementById('translatedCheck').style.display = 'block';
        log("üü© Sinhala file loaded");
    };
    reader.readAsText(e.target.files[0]);
});

async function syncSubtitles() {
    const syncBtn = document.getElementById("syncBtn");
    syncBtn.disabled = true;
    syncBtn.textContent = "‚è≥ Processing...";
    document.getElementById("logText").textContent = "";

    const originalSubs = parseSRT(originalContent);
    const translatedSubs = parseSRT(translatedContent);
    if (!model) await loadModel();

    log("üöÄ Smart matching start!");
    const merged = await smartMatch(originalSubs, translatedSubs);

    outputContent = merged.map(s => `${s.index}\n${s.timing}\n${s.text}\n`).join("\n");
    document.getElementById('previewText').textContent = outputContent.slice(0, 1000) + '...';
    document.getElementById('previewBox').style.display = 'block';
    document.getElementById('downloadBtn').style.display = 'inline-block';
    log("‚úÖ Smart matching complete!");
    syncBtn.disabled = false;
    syncBtn.textContent = "üîÑ Smart Sync ‡∂ö‡∂ª‡∂±‡∑ä‡∂±";
}

function downloadOutput() {
    const blob = new Blob([outputContent], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'SmartSynced_AI_Subtitles.srt';
    a.click();
}
</script>
</body>
</html>
