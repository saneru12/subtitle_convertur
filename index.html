<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subtitle Timing Synchronizer + Sinhala Translation</title>
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/727/727245.png">

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      background: white;
      width: 90%;
      max-width: 800px;
      margin-top: 50px;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      font-size: 1.6em;
      color: #333;
      margin-bottom: 10px;
    }

    .file-section {
      margin: 20px 0;
    }

    .file-section label {
      font-weight: 600;
    }

    .file-input {
      display: block;
      margin-top: 8px;
      padding: 8px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #f9fafb;
    }

    .button-group {
      text-align: center;
      margin-top: 15px;
    }

    button {
      background: linear-gradient(90deg, #667eea, #764ba2);
      border: none;
      color: white;
      padding: 10px 18px;
      margin: 5px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s ease;
    }

    button:hover:not(:disabled) {
      background: linear-gradient(90deg, #5a67d8, #6b46c1);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #statusBox {
      margin-top: 12px;
      text-align: center;
      font-weight: 500;
    }

    /* Progress bar */
    #progressArea {
      margin: 15px 0;
    }
    .progress-bar {
      width: 100%;
      height: 28px;
      background: #e5e7eb;
      border-radius: 14px;
      overflow: hidden;
      margin-top: 8px;
      box-shadow: inset 0 -2px 4px rgba(0,0,0,0.05);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 300ms ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 13px;
      font-weight: 700;
    }

    #previewBox {
      display: none;
      margin-top: 15px;
      background: #f1f5f9;
      border-radius: 10px;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
    }

    #previewText {
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 13px;
      color: #333;
    }

    #downloadBtn {
      display: none;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé¨ Subtitle Timing Synchronizer + Sinhala Translator</h1>

    <div class="file-section">
      <label>üü¢ Original Subtitle (.srt):</label>
      <input type="file" id="originalFile" class="file-input" accept=".srt">
    </div>

    <div class="file-section">
      <label>üü° Translated Subtitle (Optional):</label>
      <input type="file" id="translatedFile" class="file-input" accept=".srt">
    </div>

    <div class="button-group">
      <button id="syncBtn" onclick="syncSubtitles()">üîÑ Sync</button>
    </div>

    <div id="progressArea" style="display:none;">
      <div class="status" id="progressStatus">‚è≥ Starting...</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:0%">0%</div>
      </div>
    </div>

    <div id="statusBox"></div>

    <div id="previewBox">
      <h3>üìú Preview:</h3>
      <pre id="previewText"></pre>
    </div>

    <button id="downloadBtn" onclick="downloadSRT()">‚¨áÔ∏è Download Synced SRT</button>
  </div>

  <script>
    let originalContent = "";
    let translatedContent = "";
    let outputContent = "";

    document.getElementById("originalFile").addEventListener("change", (e) => loadFile(e, true));
    document.getElementById("translatedFile").addEventListener("change", (e) => loadFile(e, false));

    function loadFile(event, isOriginal) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        if (isOriginal) originalContent = e.target.result;
        else translatedContent = e.target.result;
        showStatus(`‚úÖ ${file.name} loaded successfully.`, "success");
      };
      reader.readAsText(file);
    }

    function parseSRT(content) {
      const blocks = content.split(/\n\s*\n/);
      return blocks.map(block => {
        const lines = block.split("\n");
        return {
          index: lines[0],
          timing: lines[1],
          text: lines.slice(2).join(" ")
        };
      });
    }

    function showStatus(msg, type) {
      const el = document.getElementById("statusBox");
      el.textContent = msg;
      el.style.color = type === "error" ? "red" : "green";
    }

    function setProgress(percent, label) {
      const area = document.getElementById("progressArea");
      const fill = document.getElementById("progressFill");
      const status = document.getElementById("progressStatus");
      area.style.display = "block";
      const safePct = Math.max(0, Math.min(100, percent));
      fill.style.width = safePct + "%";
      fill.textContent = safePct + "%";
      status.textContent = label || `Processing... ${safePct}%`;
    }

    async function googleTranslateToSinhala(text) {
      const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=si&dt=t&q=${encodeURIComponent(text)}`;
      const response = await fetch(url);
      const data = await response.json();
      return data[0].map(item => item[0]).join("");
    }

    async function syncSubtitles() {
      if (!originalContent) {
        showStatus("‚ö†Ô∏è Original subtitle ‡∂ë‡∂ö upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!", "error");
        return;
      }

      const btn = document.getElementById("syncBtn");
      btn.disabled = true;
      btn.textContent = "‚è≥ Processing...";
      setProgress(0, "Initializing...");

      try {
        const originalSubs = parseSRT(originalContent);
        let translatedSubs = translatedContent ? parseSRT(translatedContent) : [];
        const total = originalSubs.length;
        const synced = [];

        for (let i = 0; i < total; i++) {
          const idx = i + 1;
          let targetText = "";

          if (translatedSubs[i] && translatedSubs[i].text && translatedSubs[i].text.trim() !== "") {
            targetText = translatedSubs[i].text;
          } else {
            setProgress(Math.round((i / total) * 100), `Translating line ${idx}/${total}...`);
            targetText = await googleTranslateToSinhala(originalSubs[i].text);
          }

          synced.push({
            index: idx,
            timing: originalSubs[i].timing,
            text: targetText
          });

          const pct = Math.round((idx / total) * 100);
          setProgress(pct, `Processed ${idx}/${total} (${pct}%)`);
          await new Promise(r => setTimeout(r, 100));
        }

        outputContent = synced.map(s => `${s.index}\n${s.timing}\n${s.text}\n`).join("\n");

        document.getElementById("previewText").textContent = outputContent.slice(0, 1000) + "\n...";
        document.getElementById("previewBox").style.display = "block";
        document.getElementById("downloadBtn").style.display = "inline-block";
        showStatus(`‚úÖ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í! Subtitles ${synced.length}‡∂ö‡∑ä sync ‡∑Ä‡∑î‡∂´‡∑è.`, "success");

        setProgress(100, "Completed ‚úÖ");
        setTimeout(() => {
          document.getElementById("progressArea").style.display = "none";
        }, 1500);
      } catch (e) {
        showStatus("‚ùå Error: " + (e.message || e), "error");
        setProgress(0, "Failed");
      } finally {
        btn.disabled = false;
        btn.textContent = "üîÑ Sync";
      }
    }

    function downloadSRT() {
      const blob = new Blob([outputContent], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "synced_subtitles.srt";
      link.click();
    }
  </script>
</body>
</html>
