<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subtitle Timing Synchronizer with Spoken Sinhala</title>
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/727/727245.png">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:10px;}
.container{max-width:900px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);padding:20px;}
h1{text-align:center;color:#333;margin-bottom:10px;font-size:clamp(20px,5vw,32px);}
.subtitle{text-align:center;color:#666;margin-bottom:20px;font-size:clamp(12px,3vw,16px);padding:0 10px;}
.upload-section{display:grid;grid-template-columns:1fr;gap:15px;margin-bottom:20px;}
@media(min-width:640px){.container{padding:40px}.upload-section{grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px}}
.upload-box{border:3px dashed #667eea;border-radius:15px;padding:20px;text-align:center;transition:all .3s;cursor:pointer;}
.upload-box:hover{border-color:#764ba2;background:#f8f9ff;}
.upload-box.uploaded{border-color:#10b981;background:#f0fdf4;}
.upload-box h3{color:#333;margin-bottom:10px;font-size:clamp(16px,4vw,20px);}
.upload-box p{color:#666;font-size:clamp(12px,3vw,14px);margin-bottom:15px;}
.btn{padding:10px 20px;border:none;border-radius:10px;font-size:clamp(14px,3vw,16px);font-weight:bold;cursor:pointer;transition:all .3s;}
@media(min-width:640px){.btn{padding:12px 30px}}
.btn-upload{background:#667eea;color:white;}
.btn-upload:hover{background:#5568d3;}
.btn-sync{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;font-size:clamp(14px,4vw,18px);padding:12px 25px;width:100%;}
@media(min-width:640px){.btn-sync{padding:15px 40px;width:auto}}
.btn-sync:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,0.2);}
.btn-sync:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.btn-download{background:#10b981;color:white;font-size:clamp(14px,4vw,18px);padding:12px 25px;width:100%;}
@media(min-width:640px){.btn-download{padding:15px 40px;width:auto}}
.btn-download:hover{background:#059669;}
.button-group{display:flex;flex-direction:column;gap:10px;justify-content:center;margin-bottom:20px;}
@media(min-width:640px){.button-group{flex-direction:row;gap:15px}}
.status{background:#eff6ff;border:2px solid #3b82f6;border-radius:10px;padding:12px;text-align:center;margin-bottom:15px;font-weight:bold;color:#1e40af;font-size:clamp(12px,3vw,16px);}
.status.success{background:#f0fdf4;border-color:#10b981;color:#065f46;}
.status.error{background:#fef2f2;border-color:#ef4444;color:#991b1b;}
.status.warning{background:#fffbeb;border-color:#f59e0b;color:#92400e;}
.preview{background:#f9fafb;border:2px solid #e5e7eb;border-radius:10px;padding:15px;margin-bottom:15px;display:none;}
.preview h3{color:#333;margin-bottom:10px;font-size:clamp(16px,4vw,20px);}
.preview pre{background:white;padding:12px;border-radius:8px;border:1px solid #e5e7eb;max-height:250px;overflow-y:auto;font-size:clamp(10px,2.5vw,12px);white-space:pre-wrap;word-break:break-word;}
.instructions{background:#fef3c7;border:2px solid #fbbf24;border-radius:10px;padding:15px;}
.instructions h4{color:#92400e;margin-bottom:10px;font-size:clamp(14px,3.5vw,18px);}
.instructions ol{color:#78350f;padding-left:20px;font-size:clamp(12px,3vw,14px);}
.instructions li{margin-bottom:5px;}
.notice{background:#fff3cd;color:#856404;border:2px solid #ffeeba;border-radius:10px;padding:10px 15px;margin-bottom:15px;text-align:center;font-weight:bold;font-size:clamp(12px,3vw,16px);}
.icon{font-size:clamp(32px,8vw,48px);margin-bottom:10px;}
.checkmark{color:#10b981;font-size:clamp(16px,4vw,20px);margin-top:10px;display:none;}
#downloadBtn{display:none;}
.optional-badge{display:inline-block;background:#fbbf24;color:white;padding:3px 8px;border-radius:12px;font-size:clamp(9px,2vw,11px);font-weight:bold;margin-left:5px;}
</style>
</head>
<body>
<div class="container">
<div class="notice">üß† Smart Matching ‡∂ë‡∂ö‡∂ß ‡∂∂‡∑ú‡∑Ñ‡∑ù ‡∑Ä‡∑ö‡∂Ω‡∑è‡∑Ä‡∂ö‡∑ä ‡∂ú‡∂≠ ‡∑Ä‡∂±‡∑î ‡∂á‡∂≠. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂∂‡∂Ω‡∑è ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±...</div>
<h1>üé¨ Subtitle Smart Synchronizer</h1>
<p class="subtitle">Original English ‚Üí Spoken Sinhala Subtitle Converter</p>

<div class="upload-section">
<div class="upload-box" id="originalBox" onclick="document.getElementById('originalFile').click()">
<div class="icon">‚è±Ô∏è</div>
<h3>Original Subtitle</h3>
<p>(English / Other language)</p>
<button class="btn btn-upload">üìÅ Upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
<div class="checkmark" id="originalCheck">‚úì Uploaded</div>
<input type="file" id="originalFile" accept=".srt">
</div>

<div class="upload-box" id="translatedBox" onclick="document.getElementById('translatedFile').click()">
<div class="icon">üìù</div>
<h3>Sinhala Subtitle <span class="optional-badge">Optional</span></h3>
<p>(If you already have translated file)</p>
<button class="btn btn-upload">üìÅ Upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
<div class="checkmark" id="translatedCheck">‚úì Uploaded</div>
<input type="file" id="translatedFile" accept=".srt">
</div>
</div>

<div id="statusBox" class="status" style="display:none;"></div>

<div class="button-group">
<button class="btn btn-sync" id="syncBtn" onclick="syncSubtitles()">üîÑ Smart Sync ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
<button class="btn btn-download" id="downloadBtn" onclick="downloadOutput()">‚¨áÔ∏è Download ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
</div>

<div class="preview" id="logBox" style="display:none;background:#000;color:#0f0;max-height:200px;overflow-y:auto;">
<h3 style="color:white;">Live Log:</h3>
<pre id="logText" style="background:#000;color:#0f0;border:none;padding:5px;margin:0;white-space:pre-wrap;"></pre>
</div>

<div class="preview" id="previewBox">
<h3>Preview:</h3>
<pre id="previewText"></pre>
</div>

<div class="instructions">
<h4>üìå ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂± ‡∂Ü‡∂ö‡∑è‡∂ª‡∂∫:</h4>
<ol>
<li>English subtitle ‡∂ë‡∂ö upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</li>
<li>(Optional) Sinhala subtitle ‡∂ë‡∂ö‡∂ö‡∑ä upload ‡∂ö‡∂ª‡∂Ω‡∑è Smart Sync ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</li>
<li>‡∂ë‡∂ö‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠‡∑ä‡∂±‡∂∏‡∑ä System ‡∂ë‡∂ö English ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä‡∂∏ Spoken Sinhala‡∂ß translate ‡∂ö‡∂ª‡∂∫‡∑í</li>
<li>Real-time log ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä progress ‡∂ë‡∂ö ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±</li>
<li>Result ‡∂ë‡∂ö download ‡∂ö‡∂ª‡∂Ω‡∑è sub ‡∂ë‡∂ö‡∑ö ‡∂Ø‡∑è‡∂±‡∑ä‡∂±</li>
</ol>
</div>
</div>

<script>
let originalContent=null,translatedContent=null,outputContent=null;
function log(m){const l=document.getElementById("logBox"),t=document.getElementById("logText");l.style.display="block";t.textContent+=m+"\n";l.scrollTop=l.scrollHeight;}

document.getElementById('originalFile').addEventListener('change',e=>{
 const f=e.target.files[0];if(!f)return;
 const r=new FileReader();
 r.onload=x=>{originalContent=x.target.result;
 document.getElementById('originalBox').classList.add('uploaded');
 document.getElementById('originalCheck').style.display='block';
 showStatus('Original subtitle uploaded ‚úì','success');log("üü¶ Original subtitle loaded");
 };r.readAsText(f);
});
document.getElementById('translatedFile').addEventListener('change',e=>{
 const f=e.target.files[0];if(!f)return;
 const r=new FileReader();
 r.onload=x=>{translatedContent=x.target.result;
 document.getElementById('translatedBox').classList.add('uploaded');
 document.getElementById('translatedCheck').style.display='block';
 showStatus('Sinhala subtitle uploaded ‚úì','success');log("üü© Translated subtitle loaded");
 };r.readAsText(f);
});

function parseSRT(c){const b=c.trim().split(/\n\s*\n/);return b.map(x=>{const l=x.split('\n');return{index:l[0],timing:l[1],text:l.slice(2).join('\n')}});}
function normalizeText(t){return t.toLowerCase().replace(/[.,!?;:"'\\-‚Äî()[\]{}]/g,'').replace(/\s+/g,' ').trim();}
function calculateSimilarity(a,b){const l1=a.length,l2=b.length;if(l1===0)return l2;if(l2===0)return l1;let m=0;const ml=Math.max(l1,l2);for(let i=0;i<Math.min(l1,l2);i++){if(a[i]===b[i])m++;}return m/ml;}

async function translateText(text){
 try{
 const res=await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=si&dt=t&q=${encodeURIComponent(text)}`);
 const d=await res.json();
 if(d&&d[0]&&d[0][0]&&d[0][0][0]){
 let tr=d[0][0][0];
 return makeSinhalaConversational(tr);
 }
 return text;
 }catch(e){log("‚ö†Ô∏è Translate fail: "+e.message);return text;}
}

function makeSinhalaConversational(text){
 let r=text;
 const conv={
 '‡∂á‡∂≠':'‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è','‡∂±‡∑ê‡∂≠':'‡∂±‡∑ë','‡∂î‡∂∂':'‡∂î‡∂∫‡∑è','‡∂î‡∑Ñ‡∑î':'‡∂ë‡∂∫‡∑è','‡∂á‡∂∫':'‡∂ë‡∂∫‡∑è','‡∂ë‡∂∫':'‡∂í‡∂ö','‡∂∏‡∑ô‡∂∫':'‡∂∏‡∑ö‡∂ö',
 '‡∂ö‡∂ª‡∂±‡∑î ‡∂Ω‡∑ê‡∂∂‡∑ö':'‡∂ö‡∂ª‡∂±‡∑Ä‡∑è','‡∂Ω‡∑ê‡∂∂‡∑ö':'‡∂Ω‡∑ê‡∂∂‡∑ô‡∂±‡∑Ä‡∑è','‡∑Ä‡∑ö':'‡∑Ä‡∑ô‡∂±‡∑Ä‡∑è','‡∑Ä‡∑í‡∂∫':'‡∂ã‡∂±‡∑è','‡∂ö‡∑Ö':'‡∂ö‡∑Ö‡∑è','‡∂∫‡∂±‡∑Ä‡∑è':'‡∂∫‡∂±‡∑Ä‡∑è',
 '‡∂ë‡∂±‡∑Ä‡∑è':'‡∂ë‡∂±‡∑Ä‡∑è','‡∂á‡∂≠‡∑ä‡∂≠‡∑ö':'‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑ä‡∂±‡∑ö','‡∂ö‡∂ª‡∂∏‡∑í':'‡∂ö‡∂ª‡∂±‡∑Ä‡∑è','‡∂∫‡∂∏‡∑í':'‡∂∫‡∂±‡∑Ä‡∑è','‡∂ë‡∂∏‡∑í':'‡∂ë‡∂±‡∑Ä‡∑è','‡∂ö‡∑Ö‡∑ô‡∂∏‡∑í':'‡∂ö‡∑Ö‡∑è',
 '‡∂ú‡∑í‡∂∫‡∑ô‡∂∏‡∑í':'‡∂ú‡∑í‡∂∫‡∑è','‡∂Ü‡∑Ä‡∑ô‡∂∏‡∑í':'‡∂Ü‡∑Ä‡∑è','‡∂î‡∂∂‡∂ß':'‡∂î‡∂∫‡∑è‡∂ß','‡∂∏‡∂∏':'‡∂∏‡∂∏','‡∂Ö‡∂¥‡∑í':'‡∂Ö‡∂¥‡∑í','‡∂á‡∂≠‡∑ä‡∂≠‡∂ß':'‡∂Ö‡∂±‡∑í‡∂≠‡∑ä','‡∂Ü‡∑Ñ‡∑ä':'‡∂Ö‡∂¥‡∑ù'
 };
 for(const [f,i]of Object.entries(conv)){r=r.replace(new RegExp(f,'g'),i);}
 r=r.replace(/‡∂∫$/g,'');
 return r;
}

async function syncSubtitles(){
 if(!originalContent){showStatus('‚ö†Ô∏è Original subtitle file ‡∂ë‡∂ö upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!','error');return;}
 const btn=document.getElementById('syncBtn');
 btn.disabled=true;btn.textContent='‚è≥ Processing...';document.getElementById("logText").textContent="";
 try{
 const orig=parseSRT(originalContent);
 let trans=translatedContent?parseSRT(translatedContent):[];
 log("üü¶ Original subs: "+orig.length);
 if(trans.length>0)log("üü© Translated subs: "+trans.length);
 const used=new Set(),out=[];
 showStatus('üîÑ Smart matching...','warning');
 for(let i=0;i<orig.length;i++){
 const o=orig[i];log(`‚û°Ô∏è ${i+1}/${orig.length} ${o.text}`);
 let final=null;
 if(trans.length>0){
 let best=null,score=0,idx=-1;
 const normO=normalizeText(o.text);
 for(let j=0;j<trans.length;j++){
 if(used.has(j))continue;
 const normT=normalizeText(trans[j].text);
 const sim=calculateSimilarity(normO,normT);
 if(sim>score){score=sim;best=trans[j].text;idx=j;}
 if(sim>0.7)break;
 }
 if(score>0.4){used.add(idx);final=best;}
 }
 if(!final){log("üåê No Sinhala found ‚Üí translating...");final=await translateText(o.text);}
 out.push({index:i+1,timing:o.timing,text:final});
 log("‚úîÔ∏è Done: "+final.slice(0,60)+"...");await new Promise(r=>setTimeout(r,200));
 }
 outputContent=out.map(s=>`${s.index}\n${s.timing}\n${s.text}\n`).join('\n');
 document.getElementById('previewText').textContent=outputContent.slice(0,1000)+'...';
 document.getElementById('previewBox').style.display='block';
 document.getElementById('downloadBtn').style.display='inline-block';
 showStatus(`‚úÖ Smart Sync complete (${out.length} lines)`,`success`);
 log("üèÅ All done!");
 }catch(e){showStatus('‚ùå '+e.message,'error');log("‚ùå Error: "+e.message);}
 finally{btn.disabled=false;btn.textContent='üîÑ Smart Sync ‡∂ö‡∂ª‡∂±‡∑ä‡∂±';}
}

function downloadOutput(){
 if(!outputContent)return;
 const blob=new Blob([outputContent],{type:'text/plain;charset=utf-8'});
 const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='spoken_sinhala_subtitles.srt';a.click();
 URL.revokeObjectURL(a.href);
}
function showStatus(m,t){const s=document.getElementById('statusBox');s.textContent=m;s.className='status '+t;s.style.display='block';}
</script>
</body>
</html>
